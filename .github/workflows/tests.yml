name: Tests

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_paths: tests lib

  tests:
    name: Run bashunit tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install bashunit (Linux)
        if: runner.os == 'Linux'
        run: |
          curl -s https://bashunit.typeddevs.com/install.sh | bash

      - name: Install bashunit (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bashunit

      - name: Run tests
        run: |
          bashunit --parallel tests/

      - name: Run tests with verbose output
        if: failure()
        run: |
          VERBOSE=true bashunit tests/

  test-dry-run:
    name: Test dry-run mode
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install bashunit
        run: |
          curl -s https://bashunit.typeddevs.com/install.sh | bash

      - name: Test dry-run mode
        run: |
          DRY_RUN=true bashunit tests/

  validate-script:
    name: Validate setup.sh
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check script is executable
        run: |
          chmod +x setup.sh
          test -x setup.sh

      - name: Validate bash syntax
        run: |
          bash -n setup.sh

      - name: Source script without execution
        run: |
          bash -c 'source setup.sh && echo "Script sourced successfully"'

  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install bashunit
        run: |
          curl -s https://bashunit.typeddevs.com/install.sh | bash

      - name: Run tests and generate report
        run: |
          bashunit tests/ > test-results.txt 2>&1 || true
          cat test-results.txt

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.txt
          retention-days: 30

  integration-test:
    name: Integration Test (Docker)
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Test in Alpine container
        run: |
          docker run --rm -v $PWD:/workspace -w /workspace alpine:latest sh -c '
            apk add --no-cache bash git curl github-cli
            curl -s https://bashunit.typeddevs.com/install.sh | bash
            bashunit tests/
          '

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, tests, test-dry-run, validate-script]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | ${{ needs.shellcheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (Ubuntu) | ${{ needs.tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry-run Test | ${{ needs.test-dry-run.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Script Validation | ${{ needs.validate-script.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.shellcheck.result == 'failure' ||
          needs.tests.result == 'failure' ||
          needs.test-dry-run.result == 'failure' ||
          needs.validate-script.result == 'failure'
        run: exit 1
